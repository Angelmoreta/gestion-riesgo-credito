{% extends 'creditos/base_credito.html' %}
{% load i18n crispy_forms_tags %}

{% block title %}{% trans 'Subir Documento' %}{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{% url 'creditos:analisis_detalle' analisis.pk %}">
            {{ analisis.cliente.get_nombre_completo }}
        </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">{% trans 'Subir Documento' %}</li>
{% endblock %}

{% block creditos_content %}
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-file-upload me-2"></i>
                {% trans 'Subir Documento' %}
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <div class="d-flex">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-info-circle fa-2x mt-1"></i>
                    </div>
                    <div>
                        <h6>{% trans 'Información del Análisis' %}</h6>
                        <p class="mb-1">
                            <strong>{% trans 'Cliente:' %}</strong> {{ analisis.cliente.get_nombre_completo }}
                        </p>
                        <p class="mb-1">
                            <strong>{% trans 'Tipo de Crédito:' %}</strong> {{ analisis.get_tipo_credito_display }}
                        </p>
                        <p class="mb-0">
                            <strong>{% trans 'Monto Solicitado:' %}</strong> ${{ analisis.monto_solicitado|floatformat:2|intcomma }}
                        </p>
                    </div>
                </div>
            </div>
            
            <form method="post" enctype="multipart/form-data" id="documentoForm">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.tipo_documento|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.fecha_emision|as_crispy_field }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="id_archivo" class="form-label">
                        {{ form.archivo.label }} <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input type="file" class="form-control" name="archivo" required 
                               id="id_archivo" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                        <button class="btn btn-outline-secondary" type="button" id="btnLimpiar">
                            <i class="fas fa-times"></i> {% trans 'Limpiar' %}
                        </button>
                    </div>
                    <div class="form-text">
                        {% trans 'Formatos permitidos: PDF, JPG, PNG, DOC, DOCX, XLS, XLSX (Máx. 5MB)' %}
                    </div>
                </div>
                
                {{ form.descripcion|as_crispy_field }}
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'creditos:analisis_detalle' analisis.pk %}" 
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> {% trans 'Cancelar' %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i> {% trans 'Subir Documento' %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Limpiar el campo de archivo
        document.getElementById('btnLimpiar').addEventListener('click', function() {
            document.getElementById('id_archivo').value = '';
        });
        
        // Validar el tamaño del archivo antes de enviar el formulario
        document.getElementById('documentoForm').addEventListener('submit', function(e) {
            const archivoInput = document.getElementById('id_archivo');
            const maxSize = 5 * 1024 * 1024; // 5MB en bytes
            
            if (archivoInput.files.length > 0) {
                const archivo = archivoInput.files[0];
                
                if (archivo.size > maxSize) {
                    e.preventDefault();
                    alert('{% trans 'El archivo es demasiado grande. El tamaño máximo permitido es de 5MB.' %}');
                    return false;
                }
                
                // Validar extensión del archivo
                const extensionesPermitidas = ['.pdf', '.jpg', '.jpeg', '.png', '.doc', '.docx', '.xls', '.xlsx'];
                const nombreArchivo = archivo.name.toLowerCase();
                const extensionValida = extensionesPermitidas.some(ext => nombreArchivo.endsWith(ext));
                
                if (!extensionValida) {
                    e.preventDefault();
                    alert('{% trans 'Formato de archivo no permitido. Solo se aceptan PDF, imágenes, Word y Excel.' %}');
                    return false;
                }
            }
            
            return true;
        });
        
        // Inicializar el datepicker para la fecha de emisión
        const fechaEmision = document.getElementById('id_fecha_emision');
        if (fechaEmision) {
            // Usar flatpickr o el datepicker que estés utilizando en tu proyecto
            flatpickr(fechaEmision, {
                dateFormat: 'Y-m-d',
                allowInput: true,
                maxDate: 'today',
                locale: 'es',
                disableMobile: true
            });
        }
    });
</script>
{% endblock %}
